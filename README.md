![Qoinz](/qoinz-android/res/drawable-xhdpi/ic_launcher.png)

# qoinz

Pay coin machines with a swipe of your phone

# Why?

According to the European Vending Association, there are 4 million vending machines in Europe and they handle 80 million transactions per day, to a total value of almost 12 billion Euro per year.

Many of them only accept coins - it would be much more convenient if customers could pay electronically.  However, replacing the large number of installed vending machines would be prohibitively expensive.

# What?

Qoinz is a low-cost add-on to existing vending machines to customers to pay by swiping their NFC-enabled phone.

The demo solution consists of

*   an Arduino-based hardware add-on, to be attached to the existing vending machine (illustrated here by a coin mechanism from an arcade machine), including
    *   an MRFC522 NFC interface
    *   a NeoPixel ring for customer feedback - animating different colours/patterns for different behaviors
*   an Android app that runs on the customers phone, using
    *   the RealEx Hosted Payment Page API for accepting payment details
    *   the NFC Card Host Emulation API for NFC communication
    *   the Estimote API for proximity detection
*   a Java-Servlet-based web server that runs in the cloud, using
    *   the RealEx Payment API for processing payments.

As the customer approaches a vending machine (with a co-located Estimote beacon), the Android app detects this and triggers a user notification with a call to action to buy more tokens (using RealEx Payments).  As the customer places their phone against the NFC reader, they get a different notification that allows them to approve payment.  (A checkbox allows the user to grant approval automatically in future.)  The customer gets feedback on their transaction via the NeoPixel ring and, on completion, the vending operation completes as if a physical coin had been inserted in the coin mechanism - at least, the electrical signals generated to the rest of the vending machine are the same.

See [hardware and screenshots](https://docs.google.com/presentation/d/1pRpaus-nCW_VsB7L8KHYGUH-6UTfwPFPjNdk1oVB4fo/edit?usp=sharing).

# RealEx Finapps

This was an entry for the RealEx Payments Finapps Party, held at Impact Hub Kings Cross on 11-12 March 2016, and [placed third](https://twitter.com/AngelHack/status/708731515505659904).

# Challenges

The main challenges here were

*   the time limit - the hackathon was only 18 hours, and the solution required three separate parts (with only 1 developer)
*   the coin mechanism interface - there was no documentation online about the coin mechanism (bought cheap from eBay), so it neeeded reverse-engineering based on other contemporary models of coin mech and probing with a multimeter and Arduino test program
*   the NFC interface - the [Android NFC Host-based Card Emulation API](http://developer.android.com/guide/topics/connectivity/nfc/hce.html) requires the peer to talk ISO 7816-4, which is built on ISO 14443-4, so the Arduino code needed to implement (a subset of) these
*   getting the RealEx APIs working in Eclipse - although the APIs themselves are quite straight-forward, they're not built for easy import into Eclipse projects (either Android or Servlet), so the build needed a bit of "massaging".

# Futures

The main enhancement required to make this work "properly" is proper security - currently, the phone says to the Arduino "trust me, I have paid", which obviously isn't very secure.  A better solution would be for the Arduino to issue a challenge over NFC which the phone would proxy (via its data connection) to the web server.  The web server would respond to the challenge with a digital signature (after verifying and decrementing the customer's account) which the phone would pass back to the Arduino.  The Arduino could verify the signature (and hence accept the payment) without ever needing a direct communication channel of its own.  Clearly, each challenge generated by the Arduino must be unique, e.g. using a unique sequence number.

If the phone passes a challenge from the Arduino to the web server (and hence the customer's account has been decremented) but the challenge response is not signalled back to the Arduino (or the Arduino receives it but can't satisfy the operation, e.g. because it has run out of items to vend), the customer has lost money.  To avoid this, when the phone believes that a challenge response has been issued but not used, it can signal this back to the web server, so that the web server can refund the customer.  To prevent an attack in which a thief signals that all challenge responses have been isseud but not used, the Arduino can include in its (digitally-signed) challenge a history of the most recent accepted challenge responses - if the disputed response is in the list, the web server knows that the dispute was fraudulent.

This communication channel from the Arduino to the web server could be used for other purposes too, such as signaling the quantity of vendable items still in the machine, or the number of physical coins accepted by the coin mechanism - effectively IoT-enabling the vending machine without requiring it to have an Internet connection of its own.

The other gap at present is that selling unused Qoinz back hasn't been implemented.
